(function() {
  module.exports = function(colorPicker) {
    return {
      Emitter: (require('../modules/Emitter'))(),
      element: null,
      color: null,
      emitOutputFormat: function(format) {
        return this.Emitter.emit('outputFormat', format);
      },
      onOutputFormat: function(callback) {
        return this.Emitter.on('outputFormat', callback);
      },
      activate: function() {
        var _isClicking, hasChild;
        this.element = {
          el: (function() {
            var _classPrefix, _el;
            _classPrefix = colorPicker.element.el.className;
            _el = document.createElement('div');
            _el.classList.add(_classPrefix + "-color");
            return _el;
          })(),
          addClass: function(className) {
            this.el.classList.add(className);
            return this;
          },
          removeClass: function(className) {
            this.el.classList.remove(className);
            return this;
          },
          height: function() {
            return this.el.offsetHeight;
          },
          add: function(element) {
            this.el.appendChild(element);
            return this;
          },
          previousColor: null,
          setColor: function(smartColor) {
            var _color;
            _color = smartColor.toRGBA();
            if (this.previousColor && this.previousColor === _color) {
              return;
            }
            this.el.style.backgroundColor = _color;
            return this.previousColor = _color;
          }
        };
        colorPicker.element.add(this.element.el);
        setTimeout((function(_this) {
          return function() {
            var _newHeight;
            _newHeight = colorPicker.element.height() + _this.element.height();
            return colorPicker.element.setHeight(_newHeight);
          };
        })(this));
        hasChild = function(element, child) {
          var _parent;
          if (child && (_parent = child.parentNode)) {
            if (child === element) {
              return true;
            } else {
              return hasChild(element, _parent);
            }
          }
          return false;
        };
        _isClicking = false;
        colorPicker.onMouseDown((function(_this) {
          return function(e, isOnPicker) {
            if (!(isOnPicker && hasChild(_this.element.el, e.target))) {
              return;
            }
            e.preventDefault();
            return _isClicking = true;
          };
        })(this));
        colorPicker.onMouseMove(function(e) {
          return _isClicking = false;
        });
        colorPicker.onMouseUp((function(_this) {
          return function(e) {
            if (!_isClicking) {
              return;
            }
            colorPicker.replace(_this.color);
            return colorPicker.element.close();
          };
        })(this));
        colorPicker.onKeyDown((function(_this) {
          return function(e) {
            if (e.which !== 13) {
              return;
            }
            e.stopPropagation();
            return colorPicker.replace(_this.color);
          };
        })(this));
        setTimeout((function(_this) {
          return function() {
            var Alpha;
            Alpha = colorPicker.getExtension('Alpha');
            Alpha.onColorChanged(function(smartColor) {
              _this.element.setColor((function() {
                if (smartColor) {
                  return smartColor;
                } else {
                  return colorPicker.SmartColor.HEX('#f00');
                }
              })());
            });
          };
        })(this));
        setTimeout((function(_this) {
          return function() {
            var Alpha, Format, Return, _currentColor, _formatFormat, _inputColor, _text, setColor;
            Alpha = colorPicker.getExtension('Alpha');
            Return = colorPicker.getExtension('Return');
            Format = colorPicker.getExtension('Format');
            _text = document.createElement('p');
            _text.classList.add(_this.element.el.className + "-text");
            colorPicker.onBeforeOpen(function() {
              return _this.color = null;
            });
            _inputColor = null;
            colorPicker.onInputColor(function(smartColor, wasFound) {
              return _inputColor = wasFound ? smartColor : null;
            });
            _formatFormat = null;
            Format.onFormatChanged(function(format) {
              return _formatFormat = format;
            });
            colorPicker.onInputColor(function() {
              return _formatFormat = null;
            });
            setColor = function(smartColor) {
              var _format, _function, _outputColor, _preferredFormat;
              _preferredFormat = atom.config.get('color-picker.preferredFormat');
              _format = _formatFormat || (_inputColor != null ? _inputColor.format : void 0) || _preferredFormat || 'RGB';
              _function = smartColor.getAlpha() < 1 || atom.config.get('color-picker.alphaChannelAlways') ? smartColor["to" + _format + "A"] || smartColor["to" + _format] : smartColor["to" + _format];
              _outputColor = (function() {
                if (_inputColor && (_inputColor.format === _format || _inputColor.format === (_format + "A"))) {
                  if (smartColor.equals(_inputColor)) {
                    return _inputColor.value;
                  }
                }
                return _function.call(smartColor);
              })();
              if (_outputColor === _this.color) {
                return;
              }
              if (_inputColor && atom.config.get('color-picker.automaticReplace')) {
                colorPicker.replace(_outputColor);
              }
              _this.color = _outputColor;
              _text.innerText = _outputColor;
              return _this.emitOutputFormat(_format);
            };
            _currentColor = null;
            Alpha.onColorChanged(function(smartColor) {
              setColor(_currentColor = (function() {
                if (smartColor) {
                  return smartColor;
                } else {
                  return colorPicker.SmartColor.HEX('#f00');
                }
              })());
            });
            Format.onFormatChanged(function() {
              return setColor(_currentColor);
            });
            Return.onVisibility(function(visibility) {
              if (visibility) {
                return _this.element.addClass('is--returnVisible');
              } else {
                return _this.element.removeClass('is--returnVisible');
              }
            });
            return _this.element.add(_text);
          };
        })(this));
        return this;
      }
    };
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL2hvbWUvc3lhaWYvLmF0b20vcGFja2FnZXMvY29sb3ItcGlja2VyL2xpYi9leHRlbnNpb25zL0NvbG9yLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFLSTtFQUFBLE1BQU0sQ0FBQyxPQUFQLEdBQWlCLFNBQUMsV0FBRDtXQUNiO01BQUEsT0FBQSxFQUFTLENBQUMsT0FBQSxDQUFRLG9CQUFSLENBQUQsQ0FBQSxDQUFBLENBQVQ7TUFFQSxPQUFBLEVBQVMsSUFGVDtNQUdBLEtBQUEsRUFBTyxJQUhQO01BU0EsZ0JBQUEsRUFBa0IsU0FBQyxNQUFEO2VBQ2QsSUFBQyxDQUFBLE9BQU8sQ0FBQyxJQUFULENBQWMsY0FBZCxFQUE4QixNQUE5QjtNQURjLENBVGxCO01BV0EsY0FBQSxFQUFnQixTQUFDLFFBQUQ7ZUFDWixJQUFDLENBQUEsT0FBTyxDQUFDLEVBQVQsQ0FBWSxjQUFaLEVBQTRCLFFBQTVCO01BRFksQ0FYaEI7TUFpQkEsUUFBQSxFQUFVLFNBQUE7QUFDTixZQUFBO1FBQUEsSUFBQyxDQUFBLE9BQUQsR0FDSTtVQUFBLEVBQUEsRUFBTyxDQUFBLFNBQUE7QUFDSCxnQkFBQTtZQUFBLFlBQUEsR0FBZSxXQUFXLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUN0QyxHQUFBLEdBQU0sUUFBUSxDQUFDLGFBQVQsQ0FBdUIsS0FBdkI7WUFDTixHQUFHLENBQUMsU0FBUyxDQUFDLEdBQWQsQ0FBc0IsWUFBRixHQUFnQixRQUFwQztBQUVBLG1CQUFPO1VBTEosQ0FBQSxDQUFILENBQUEsQ0FBSjtVQU9BLFFBQUEsRUFBVSxTQUFDLFNBQUQ7WUFBZSxJQUFDLENBQUEsRUFBRSxDQUFDLFNBQVMsQ0FBQyxHQUFkLENBQWtCLFNBQWxCO0FBQTZCLG1CQUFPO1VBQW5ELENBUFY7VUFRQSxXQUFBLEVBQWEsU0FBQyxTQUFEO1lBQWUsSUFBQyxDQUFBLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFBZCxD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U0FBQyxVQUFEO2NBQ2pCLFFBQUEsQ0FBUyxhQUFBLEdBQW1CLENBQUEsU0FBQTtnQkFDeEIsSUFBRyxVQUFIO0FBQW1CLHlCQUFPLFdBQTFCO2lCQUFBLE1BQUE7QUFFSyx5QkFBTyxXQUFXLENBQUMsVUFBVSxDQUFDLEdBQXZCLENBQTJCLE1BQTNCLEVBRlo7O2NBRHdCLENBQUEsQ0FBSCxDQUFBLENBQXpCO1lBRGlCLENBQXJCO1lBUUEsTUFBTSxDQUFDLGVBQVAsQ0FBdUIsU0FBQTtxQkFBRyxRQUFBLENBQVMsYUFBVDtZQUFILENBQXZCO1lBSUEsTUFBTSxDQUFDLFlBQVAsQ0FBb0IsU0FBQyxVQUFEO2NBQ2hCLElBQUcsVUFBSDt1QkFBbUIsS0FBQyxDQUFBLE9BQU8sQ0FBQyxRQUFULENBQWtCLG1CQUFsQixFQUFuQjtlQUFBLE1BQUE7dUJBQ0ssS0FBQyxDQUFBLE9BQU8sQ0FBQyxXQUFULENBQXFCLG1CQUFyQixFQURMOztZQURnQixDQUFwQjttQkFHQSxLQUFDLENBQUEsT0FBTyxDQUFDLEdBQVQsQ0FBYSxLQUFiO1VBOUVPO1FBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQUFYO0FBK0VBLGVBQU87TUFoS0QsQ0FqQlY7O0VBRGE7QUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiMgIENvbG9yIFBpY2tlci9leHRlbnNpb25zOiBDb2xvclxuIyAgVGhlIGVsZW1lbnQgc2hvd2luZyB0aGUgY3VycmVudCBjb2xvclxuIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICBtb2R1bGUuZXhwb3J0cyA9IChjb2xvclBpY2tlcikgLT5cbiAgICAgICAgRW1pdHRlcjogKHJlcXVpcmUgJy4uL21vZHVsZXMvRW1pdHRlcicpKClcblxuICAgICAgICBlbGVtZW50OiBudWxsXG4gICAgICAgIGNvbG9yOiBudWxsXG5cbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAjICBTZXQgdXAgZXZlbnRzIGFuZCBoYW5kbGluZ1xuICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICAjIE91dHB1dCBmb3JtYXQgZXZlbnRcbiAgICAgICAgZW1pdE91dHB1dEZvcm1hdDogKGZvcm1hdCkgLT5cbiAgICAgICAgICAgIEBFbWl0dGVyLmVtaXQgJ291dHB1dEZvcm1hdCcsIGZvcm1hdFxuICAgICAgICBvbk91dHB1dEZvcm1hdDogKGNhbGxiYWNrKSAtPlxuICAgICAgICAgICAgQEVtaXR0ZXIub24gJ291dHB1dEZvcm1hdCcsIGNhbGxiYWNrXG5cbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAjICBDcmVhdGUgYW5kIGFjdGl2YXRlIENvbG9yIGVsZW1lbnRcbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgYWN0aXZhdGU6IC0+XG4gICAgICAgICAgICBAZWxlbWVudCA9XG4gICAgICAgICAgICAgICAgZWw6IGRvIC0+XG4gICAgICAgICAgICAgICAgICAgIF9jbGFzc1ByZWZpeCA9IGNvbG9yUGlja2VyLmVsZW1lbnQuZWwuY2xhc3NOYW1lXG4gICAgICAgICAgICAgICAgICAgIF9lbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgJ2RpdidcbiAgICAgICAgICAgICAgICAgICAgX2VsLmNsYXNzTGlzdC5hZGQgXCIjeyBfY2xhc3NQcmVmaXggfS1jb2xvclwiXG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9lbFxuICAgICAgICAgICAgICAgICMgVXRpbGl0eSBmdW5jdGlvbnNcbiAgICAgICAgICAgICAgICBhZGRDbGFzczogKGNsYXNzTmFtZSkgLT4gQGVsLmNsYXNzTGlzdC5hZGQgY2xhc3NOYW1lOyByZXR1cm4gdGhpc1xuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzOiAoY2xhc3NOYW1lKSAtPiBAZWwuY2xhc3NMaXN0LnJlbW92ZSBjbGFzc05hbWU7IHJldHVybiB0aGlzXG5cbiAgICAgICAgICAgICAgICBoZWlnaHQ6IC0+IEBlbC5vZmZzZXRIZWlnaHRcblxuICAgICAgICAgICAgICAgICMgQWRkIGEgY2hpbGQgb24gdGhlIENvbG9yIGVsZW1lbnRcbiAgICAgICAgICAgICAgICBhZGQ6IChlbGVtZW50KSAtPlxuICAgICAgICAgICAgICAgICAgICBAZWwuYXBwZW5kQ2hpbGQgZWxlbWVudFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1xuXG4gICAgICAgICAgICAgICAgIyBTZXQgdGhlIENvbG9yIGVsZW1lbnQgYmFja2dyb3VuZCBjb2xvclxuICAgICAgICAgICAgICAgIHByZXZpb3VzQ29sb3I6IG51bGxcbiAgICAgICAgICAgICAgICBzZXRDb2xvcjogKHNtYXJ0Q29sb3IpIC0+XG4gICAgICAgICAgICAgICAgICAgIF9jb2xvciA9IHNtYXJ0Q29sb3IudG9SR0JBKClcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlmIEBwcmV2aW91c0NvbG9yIGFuZCBAcHJldmlvdXNDb2xvciBpcyBfY29sb3JcblxuICAgICAgICAgICAgICAgICAgICBAZWwuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gX2NvbG9yXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBAcHJldmlvdXNDb2xvciA9IF9jb2xvclxuICAgICAgICAgICAgY29sb3JQaWNrZXIuZWxlbWVudC5hZGQgQGVsZW1lbnQuZWxcblxuICAgICAgICAjICBJbmNyZWFzZSBDb2xvciBQaWNrZXIgaGVpZ2h0XG4gICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgICBzZXRUaW1lb3V0ID0+XG4gICAgICAgICAgICAgICAgX25ld0hlaWdodCA9IGNvbG9yUGlja2VyLmVsZW1lbnQuaGVpZ2h0KCkgKyBAZWxlbWVudC5oZWlnaHQoKVxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLmVsZW1lbnQuc2V0SGVpZ2h0IF9uZXdIZWlnaHRcblxuICAgICAgICAjICBTZXQgb3IgcmVwbGFjZSBDb2xvciBvbiBjbGlja1xuICAgICAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICAgICAgaGFzQ2hpbGQgPSAoZWxlbWVudCwgY2hpbGQpIC0+XG4gICAgICAgICAgICAgICAgaWYgY2hpbGQgYW5kIF9wYXJlbnQgPSBjaGlsZC5wYXJlbnROb2RlXG4gICAgICAgICAgICAgICAgICAgIGlmIGNoaWxkIGlzIGVsZW1lbnRcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGhhc0NoaWxkIGVsZW1lbnQsIF9wYXJlbnRcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2VcblxuICAgICAgICAgICAgX2lzQ2xpY2tpbmcgPSBub1xuXG4gICAgICAgICAgICBjb2xvclBpY2tlci5vbk1vdXNlRG93biAoZSwgaXNPblBpY2tlcikgPT5cbiAgICAgICAgICAgICAgICByZXR1cm4gdW5sZXNzIGlzT25QaWNrZXIgYW5kIGhhc0NoaWxkIEBlbGVtZW50LmVsLCBlLnRhcmdldFxuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKVxuICAgICAgICAgICAgICAgIF9pc0NsaWNraW5nID0geWVzXG5cbiAgICAgICAgICAgIGNvbG9yUGlja2VyLm9uTW91c2VNb3ZlIChlKSAtPlxuICAgICAgICAgICAgICAgIF9pc0NsaWNraW5nID0gbm9cblxuICAgICAgICAgICAgY29sb3JQaWNrZXIub25Nb3VzZVVwIChlKSA9PlxuICAgICAgICAgICAgICAgIHJldHVybiB1bmxlc3MgX2lzQ2xpY2tpbmdcbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5yZXBsYWNlIEBjb2xvclxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLmVsZW1lbnQuY2xvc2UoKVxuXG4gICAgICAgICMgIFNldCBvciByZXBsYWNlIENvbG9yIG9uIGtleSBwcmVzcyBlbnRlclxuICAgICAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICAgICAgY29sb3JQaWNrZXIub25LZXlEb3duIChlKSA9PlxuICAgICAgICAgICAgICAgIHJldHVybiB1bmxlc3MgZS53aGljaCBpcyAxM1xuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKClcbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5yZXBsYWNlIEBjb2xvclxuXG4gICAgICAgICMgIFNldCBiYWNrZ3JvdW5kIGVsZW1lbnQgY29sb3Igb24gQWxwaGEgY2hhbmdlXG4gICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgICBzZXRUaW1lb3V0ID0+ICMgd2FpdCBmb3IgdGhlIERPTVxuICAgICAgICAgICAgICAgIEFscGhhID0gY29sb3JQaWNrZXIuZ2V0RXh0ZW5zaW9uICdBbHBoYSdcblxuICAgICAgICAgICAgICAgIEFscGhhLm9uQ29sb3JDaGFuZ2VkIChzbWFydENvbG9yKSA9PlxuICAgICAgICAgICAgICAgICAgICBAZWxlbWVudC5zZXRDb2xvciBkbyAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgc21hcnRDb2xvciB0aGVuIHJldHVybiBzbWFydENvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAjIERlZmF1bHQgdG8gI2YwMCByZWRcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGNvbG9yUGlja2VyLlNtYXJ0Q29sb3IuSEVYICcjZjAwJ1xuICAgICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgICByZXR1cm5cblxuICAgICAgICAjICBDcmVhdGUgQ29sb3IgdGV4dCBlbGVtZW50XG4gICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgICBzZXRUaW1lb3V0ID0+XG4gICAgICAgICAgICAgICAgQWxwaGEgPSBjb2xvclBpY2tlci5nZXRFeHRlbnNpb24gJ0FscGhhJ1xuICAgICAgICAgICAgICAgIFJldHVybiA9IGNvbG9yUGlja2VyLmdldEV4dGVuc2lvbiAnUmV0dXJuJ1xuICAgICAgICAgICAgICAgIEZvcm1hdCA9IGNvbG9yUGlja2VyLmdldEV4dGVuc2lvbiAnRm9ybWF0J1xuXG4gICAgICAgICAgICAgICAgIyBDcmVhdGUgdGV4dCBlbGVtZW50XG4gICAgICAgICAgICAgICAgX3RleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50ICdwJ1xuICAgICAgICAgICAgICAgIF90ZXh0LmNsYXNzTGlzdC5hZGQgXCIjeyBAZWxlbWVudC5lbC5jbGFzc05hbWUgfS10ZXh0XCJcblxuICAgICAgICAgICAgICAgICMgUmVzZXQgYmVmb3JlIGNvbG9yIHBpY2tlciBvcGVuXG4gICAgICAgICAgICAgICAgY29sb3JQaWNrZXIub25CZWZvcmVPcGVuID0+IEBjb2xvciA9IG51bGxcblxuICAgICAgICAgICAgICAgICMgS2VlcCB0cmFjayBvZiB0aGUgaW5wdXQgY29sb3IgKGZvciBpdHMgZm9ybWF0KVxuICAgICAgICAgICAgICAgIF9pbnB1dENvbG9yID0gbnVsbFxuXG4gICAgICAgICAgICAgICAgY29sb3JQaWNrZXIub25JbnB1dENvbG9yIChzbWFydENvbG9yLCB3YXNGb3VuZCkgLT5cbiAgICAgICAgICAgICAgICAgICAgX2lucHV0Q29sb3IgPSBpZiB3YXNGb3VuZFxuICAgICAgICAgICAgICAgICAgICAgICAgc21hcnRDb2xvclxuICAgICAgICAgICAgICAgICAgICBlbHNlIG51bGxcblxuICAgICAgICAgICAgICAgICMgS2VlcCB0cmFjayBvZiB0aGUgRm9ybWF0IGVsZW1lbnQgZm9ybWF0XG4gICAgICAgICAgICAgICAgX2Zvcm1hdEZvcm1hdCA9IG51bGxcbiAgICAgICAgICAgICAgICBGb3JtYXQub25Gb3JtYXRDaGFuZ2VkIChmb3JtYXQpIC0+IF9mb3JtYXRGb3JtYXQgPSBmb3JtYXRcbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5vbklucHV0Q29sb3IgLT4gX2Zvcm1hdEZvcm1hdCA9IG51bGxcblxuICAgICAgICAgICAgICAgICMgU2V0IHRoZSB0ZXh0IGVsZW1lbnQgdG8gY29udGFpbiB0aGUgQ29sb3IgZGF0YVxuICAgICAgICAgICAgICAgIHNldENvbG9yID0gKHNtYXJ0Q29sb3IpID0+XG4gICAgICAgICAgICAgICAgICAgIF9wcmVmZXJyZWRGb3JtYXQgPSBhdG9tLmNvbmZpZy5nZXQgJ2NvbG9yLXBpY2tlci5wcmVmZXJyZWRGb3JtYXQnXG4gICAgICAgICAgICAgICAgICAgIF9mb3JtYXQgPSBfZm9ybWF0Rm9ybWF0IG9yIF9pbnB1dENvbG9yPy5mb3JtYXQgb3IgX3ByZWZlcnJlZEZvcm1hdCBvciAnUkdCJ1xuXG4gICAgICAgICAgICAgICAgICAgICMgVE9ETzogVGhpcyBpcyB2ZXJ5IGZyYWdpbGVcbiAgICAgICAgICAgICAgICAgICAgX2Z1bmN0aW9uID0gaWYgc21hcnRDb2xvci5nZXRBbHBoYSgpIDwgMSB8fCBhdG9tLmNvbmZpZy5nZXQgJ2NvbG9yLXBpY2tlci5hbHBoYUNoYW5uZWxBbHdheXMnXG4gICAgICAgICAgICAgICAgICAgICAgICAoc21hcnRDb2xvcltcInRvI3sgX2Zvcm1hdCB9QVwiXSBvciBzbWFydENvbG9yW1widG8jeyBfZm9ybWF0IH1cIl0pXG4gICAgICAgICAgICAgICAgICAgIGVsc2Ugc21hcnRDb2xvcltcInRvI3sgX2Zvcm1hdCB9XCJdXG5cbiAgICAgICAgICAgICAgICAgICAgIyBJZiBhIGNvbG9yIHdhcyBpbnB1dCwgYW5kIHRoZSB2YWx1ZSBoYXNuJ3QgY2hhbmdlZCBzaW5jZSxcbiAgICAgICAgICAgICAgICAgICAgIyBzaG93IHRoZSBpbml0YWwgdmFsdWUgbm90IHRvIGNvbmZ1c2UgdGhlIHVzZXIsIGJ1dCBvbmx5XG4gICAgICAgICAgICAgICAgICAgICMgaWYgdGhlIGlucHV0IGNvbG9yIGZvcm1hdCBpcyBzdGlsbCB0aGUgc2FtZVxuICAgICAgICAgICAgICAgICAgICBfb3V0cHV0Q29sb3IgPSBkbyAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgX2lucHV0Q29sb3IgYW5kIChfaW5wdXRDb2xvci5mb3JtYXQgaXMgX2Zvcm1hdCBvciBfaW5wdXRDb2xvci5mb3JtYXQgaXMgXCIjeyBfZm9ybWF0IH1BXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc21hcnRDb2xvci5lcXVhbHMgX2lucHV0Q29sb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9pbnB1dENvbG9yLnZhbHVlXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2Z1bmN0aW9uLmNhbGwgc21hcnRDb2xvclxuXG4gICAgICAgICAgICAgICAgICAgICMgRmluaXNoIGhlcmUgaWYgdGhlIF9vdXRwdXRDb2xvciBpcyB0aGUgc2FtZSBhcyB0aGVcbiAgICAgICAgICAgICAgICAgICAgIyBjdXJyZW50IGNvbG9yXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmxlc3MgX291dHB1dENvbG9yIGlzbnQgQGNvbG9yXG5cbiAgICAgICAgICAgICAgICAgICAgIyBBdXRvbWF0aWNhbGx5IHJlcGxhY2UgY29sb3IgaW4gZWRpdG9yIGlmXG4gICAgICAgICAgICAgICAgICAgICMgYGF1dG9tYXRpY1JlcGxhY2VgIGlzIHRydWUsIGJ1dCBvbmx5IGlmIHRoZXJlIHdhcyBhblxuICAgICAgICAgICAgICAgICAgICAjIGlucHV0IGNvbG9yIGFuZCBpZiBpdCBpcyBkaWZmZXJlbnQgZnJvbSBiZWZvcmVcbiAgICAgICAgICAgICAgICAgICAgaWYgX2lucHV0Q29sb3IgYW5kIGF0b20uY29uZmlnLmdldCAnY29sb3ItcGlja2VyLmF1dG9tYXRpY1JlcGxhY2UnXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5yZXBsYWNlIF9vdXRwdXRDb2xvclxuXG4gICAgICAgICAgICAgICAgICAgICMgU2V0IGFuZCBzYXZlIHRoZSBvdXRwdXQgY29sb3JcbiAgICAgICAgICAgICAgICAgICAgQGNvbG9yID0gX291dHB1dENvbG9yXG4gICAgICAgICAgICAgICAgICAgIF90ZXh0LmlubmVyVGV4dCA9IF9vdXRwdXRDb2xvclxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBAZW1pdE91dHB1dEZvcm1hdCBfZm9ybWF0XG5cbiAgICAgICAgICAgICAgICAjIFVwZGF0ZSBvbiBhbHBoYSBjaGFuZ2UsIGtlZXAgdHJhY2sgb2YgY3VycmVudCBjb2xvclxuICAgICAgICAgICAgICAgIF9jdXJyZW50Q29sb3IgPSBudWxsXG5cbiAgICAgICAgICAgICAgICBBbHBoYS5vbkNvbG9yQ2hhbmdlZCAoc21hcnRDb2xvcikgPT5cbiAgICAgICAgICAgICAgICAgICAgc2V0Q29sb3IgX2N1cnJlbnRDb2xvciA9IGRvIC0+XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiBzbWFydENvbG9yIHRoZW4gcmV0dXJuIHNtYXJ0Q29sb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICMgRGVmYXVsdCB0byAjZjAwIHJlZFxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gY29sb3JQaWNrZXIuU21hcnRDb2xvci5IRVggJyNmMDAnXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxuXG4gICAgICAgICAgICAgICAgIyBXaGVuIEZvcm1hdCBpcyBjaGFuZ2VkLCB1cGRhdGUgY29sb3JcbiAgICAgICAgICAgICAgICBGb3JtYXQub25Gb3JtYXRDaGFuZ2VkIC0+IHNldENvbG9yIF9jdXJyZW50Q29sb3JcblxuICAgICAgICAgICAgICAgICMgV2hlbiB0aGUgYFJldHVybmAgZWxlbWVudCBpcyB2aXNpYmxlLCBhZGQgYSBjbGFzcyB0byBhbGxvd1xuICAgICAgICAgICAgICAgICMgdGhlIHRleHQgdG8gYmUgcHVzaGVkIHVwIG9yIGRvd24gYSBiaXRcbiAgICAgICAgICAgICAgICBSZXR1cm4ub25WaXNpYmlsaXR5ICh2aXNpYmlsaXR5KSA9PlxuICAgICAgICAgICAgICAgICAgICBpZiB2aXNpYmlsaXR5IHRoZW4gQGVsZW1lbnQuYWRkQ2xhc3MgJ2lzLS1yZXR1cm5WaXNpYmxlJ1xuICAgICAgICAgICAgICAgICAgICBlbHNlIEBlbGVtZW50LnJlbW92ZUNsYXNzICdpcy0tcmV0dXJuVmlzaWJsZSdcbiAgICAgICAgICAgICAgICBAZWxlbWVudC5hZGQgX3RleHRcbiAgICAgICAgICAgIHJldHVybiB0aGlzXG4iXX0=
