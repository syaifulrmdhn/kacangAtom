(function() {
  module.exports = function(colorPicker) {
    return {
      Emitter: (require('../modules/Emitter'))(),
      element: null,
      control: null,
      canvas: null,
      emitSelectionChanged: function() {
        return this.Emitter.emit('selectionChanged', this.control.selection);
      },
      onSelectionChanged: function(callback) {
        return this.Emitter.on('selectionChanged', callback);
      },
      emitColorChanged: function() {
        return this.Emitter.emit('colorChanged', this.control.selection.color);
      },
      onColorChanged: function(callback) {
        return this.Emitter.on('colorChanged', callback);
      },
      activate: function() {
        var Body;
        Body = colorPicker.getExtension('Body');
        this.element = {
          el: (function() {
            var _classPrefix, _el;
            _classPrefix = Body.element.el.className;
            _el = document.createElement('div');
            _el.classList.add(_classPrefix + "-saturation");
            return _el;
          })(),
          width: 0,
          height: 0,
          getWidth: function() {
            return this.width || this.el.offsetWidth;
          },
          getHeight: function() {
            return this.height || this.el.offsetHeight;
          },
          rect: null,
          getRect: function() {
            return this.rect || this.updateRect();
          },
          updateRect: function() {
            return this.rect = this.el.getClientRects()[0];
          },
          add: function(element) {
            this.el.appendChild(element);
            return this;
          }
        };
        Body.element.add(this.element.el, 0);
        colorPicker.onOpen((function(_this) {
          return function() {
            var _rect;
            if (!(_this.element.updateRect() && (_rect = _this.element.getRect()))) {
              return;
            }
            _this.width = _rect.width;
            return _this.height = _rect.height;
          };
        })(this));
        setTimeout((function(_this) {
          return function() {
            var Hue, Saturation, _elementHeight, _elementWidth;
            Saturation = _this;
            Hue = colorPicker.getExtension('Hue');
            _elementWidth = _this.element.getWidth();
            _elementHeight = _this.element.getHeight();
            _this.canvas = {
              el: (function() {
                var _el;
                _el = document.createElement('canvas');
                _el.width = _elementWidth;
                _el.height = _elementHeight;
                _el.classList.add(Saturation.element.el.className + "-canvas");
                return _el;
              })(),
              context: null,
              getContext: function() {
                return this.context || (this.context = this.el.getContext('2d'));
              },
              getColorAtPosition: function(x, y) {
                return colorPicker.SmartColor.HSVArray([Hue.getHue(), x / Saturation.element.getWidth() * 100, 100 - (y / Saturation.element.getHeight() * 100)]);
              },
              previousRender: null,
              render: function(smartColor) {
                var _context, _gradient, _hslArray, _joined;
                _hslArray = ((function() {
                  if (!smartColor) {
                    return colorPicker.SmartColor.HEX('#f00');
                  } else {
                    return smartColor;
                  }
                })()).toHSLArray();
                _joined = _hslArray.join(',');
                if (this.previousRender && this.previousRender === _joined) {
                  return;
                }
                _context = this.getContext();
                _context.clearRect(0, 0, _elementWidth, _elementHeight);
                _gradient = _context.createLinearGradient(0, 0, _elementWidth, 1);
                _gradient.addColorStop(.01, 'hsl(0,100%,100%)');
                _gradient.addColorStop(.99, "hsl(" + _hslArray[0] + ",100%,50%)");
                _context.fillStyle = _gradient;
                _context.fillRect(0, 0, _elementWidth, _elementHeight);
                _gradient = _context.createLinearGradient(0, 0, 1, _elementHeight);
                _gradient.addColorStop(.01, 'rgba(0,0,0,0)');
                _gradient.addColorStop(.99, 'rgba(0,0,0,1)');
                _context.fillStyle = _gradient;
                _context.fillRect(0, 0, _elementWidth, _elementHeight);
                return this.previousRender = _joined;
              }
            };
            Hue.onColorChanged(function(smartColor) {
              return _this.canvas.render(smartColor);
            });
            _this.canvas.render();
            return _this.element.add(_this.canvas.el);
          };
        })(this));
        setTimeout((function(_this) {
          return function() {
            var Hue, Saturation, hasChild;
            hasChild = function(element, child) {
              var _parent;
              if (child && (_parent = child.parentNode)) {
                if (child === element) {
                  return true;
                } else {
                  return hasChild(element, _parent);
                }
              }
              return false;
            };
            Saturation = _this;
            Hue = colorPicker.getExtension('Hue');
            _this.control = {
              el: (function() {
                var _el;
                _el = document.createElement('div');
                _el.classList.add(Saturation.element.el.className + "-control");
                return _el;
              })(),
              isGrabbing: false,
              previousControlPosition: null,
              updateControlPosition: function(x, y) {
                var _joined;
                _joined = x + "," + y;
                if (this.previousControlPosition && this.previousControlPosition === _joined) {
                  return;
                }
                requestAnimationFrame((function(_this) {
                  return function() {
                    _this.el.style.left = x + "px";
                    return _this.el.style.top = y + "px";
                  };
                })(this));
                return this.previousControlPosition = _joined;
              },
              selection: {
                x: null,
                y: 0,
                color: null
              },
              setSelection: function(e, saturation, key) {
                var _height, _position, _rect, _width, _x, _y;
                if (saturation == null) {
                  saturation = null;
                }
                if (key == null) {
                  key = null;
                }
                if (!(Saturation.canvas && (_rect = Saturation.element.getRect()))) {
                  return;
                }
                _width = Saturation.element.getWidth();
                _height = Saturation.element.getHeight();
                if (e) {
                  _x = e.pageX - _rect.left;
                  _y = e.pageY - _rect.top;
                } else if ((typeof saturation === 'number') && (typeof key === 'number')) {
                  _x = _width * saturation;
                  _y = _height * key;
                } else {
                  if (typeof this.selection.x !== 'number') {
                    this.selection.x = _width;
                  }
                  _x = this.selection.x;
                  _y = this.selection.y;
                }
                _x = this.selection.x = Math.max(0, Math.min(_width, Math.round(_x)));
                _y = this.selection.y = Math.max(0, Math.min(_height, Math.round(_y)));
                _position = {
                  x: Math.max(6, Math.min(_width - 7, _x)),
                  y: Math.max(6, Math.min(_height - 7, _y))
                };
                this.selection.color = Saturation.canvas.getColorAtPosition(_x, _y);
                this.updateControlPosition(_position.x, _position.y);
                return Saturation.emitSelectionChanged();
              },
              refreshSelection: function() {
                return this.setSelection();
              }
            };
            _this.control.refreshSelection();
            colorPicker.onInputColor(function(smartColor) {
              var h, ref, s, v;
              ref = smartColor.toHSVArray(), h = ref[0], s = ref[1], v = ref[2];
              return _this.control.setSelection(null, s, 1 - v);
            });
            Saturation.onSelectionChanged(function() {
              return Saturation.emitColorChanged();
            });
            colorPicker.onOpen(function() {
              return _this.control.refreshSelection();
            });
            colorPicker.onOpen(function() {
              return _this.control.isGrabbing = false;
            });
            colorPicker.onClose(function() {
              return _this.control.isGrabbing = false;
            });
            Hue.onColorChanged(function() {
              return _this.control.refreshSelection();
            });
            colorPicker.onMouseDown(function(e, isOnPicker) {
              if (!(isOnPicker && hasChild(Saturation.element.el, e.target))) {
                return;
              }
              e.preventDefault();
              _this.control.isGrabbing = true;
              return _this.control.setSelection(e);
            });
            colorPicker.onMouseMove(function(e) {
              if (!_this.control.isGrabbing) {
                return;
              }
              return _this.control.setSelection(e);
            });
            colorPicker.onMouseUp(function(e) {
              if (!_this.control.isGrabbing) {
                return;
              }
              _this.control.isGrabbing = false;
              return _this.control.setSelection(e);
            });
            return _this.element.add(_this.control.el);
          };
        })(this));
        return this;
      }
    };
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL2hvbWUvc3lhaWYvLmF0b20vcGFja2FnZXMvY29sb3ItcGlja2VyL2xpYi9leHRlbnNpb25zL1NhdHVyYXRpb24uY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtJO0VBQUEsTUFBTSxDQUFDLE9BQVAsR0FBaUIsU0FBQyxXQUFEO1dBQ2I7TUFBQSxPQUFBLEVBQVMsQ0FBQyxPQUFBLENBQVEsb0JBQVIsQ0FBRCxDQUFBLENBQUEsQ0FBVDtNQUVBLE9BQUEsRUFBUyxJQUZUO01BR0EsT0FBQSxFQUFTLElBSFQ7TUFJQSxNQUFBLEVBQVEsSUFKUjtNQVVBLG9CQUFBLEVBQXNCLFNBQUE7ZUFDbEIsSUFBQyxDQUFBLE9BQU8sQ0FBQyxJQUFULENBQWMsa0JBQWQsRUFBa0MsSUFBQyxDQUFBLE9BQU8sQ0FBQyxTQUEzQztNQURrQixDQVZ0QjtNQVlBLGtCQUFBLEVBQW9CLFNBQUMsUUFBRDtlQUNoQixJQUFDLENBQUEsT0FBTyxDQUFDLEVBQVQsQ0FBWSxrQkFBWixFQUFnQyxRQUFoQztNQURnQixDQVpwQjtNQWdCQSxnQkFBQSxFQUFrQixTQUFBO2VBQ2QsSUFBQyxDQUFBLE9BQU8sQ0FBQyxJQUFULENBQWMsY0FBZCxFQUE4QixJQUFDLENBQUEsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFqRDtNQURjLENBaEJsQjtNQWtCQSxjQUFBLEVBQWdCLFNBQUMsUUFBRDtlQUNaLElBQUMsQ0FBQSxPQUFPLENBQUMsRUFBVCxDQUFZLGNBQVosRUFBNEIsUUFBNUI7TUFEWSxDQWxCaEI7TUF3QkEsUUFBQSxFQUFVLFNBQUE7QUFDTixZQUFBO1FBQUEsSUFBQSxHQUFPLFdBQVcsQ0FBQyxZQUFaLENBQXlCLE1BQXpCO1FBSVAsSUFBQyxDQUFBLE9BQUQsR0FDSTtVQUFBLEVBQUEsRUFBTyxDQUFBLFNBQUE7QUFDSCxnQkFBQTtZQUFBLFlBQUEsR0FBZSxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZ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LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiMgIENvbG9yIFBpY2tlci9leHRlbnNpb25zOiBTYXR1cmF0aW9uXG4jICBDb2xvciBTYXR1cmF0aW9uIGNvbnRyb2xsZXJcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gICAgbW9kdWxlLmV4cG9ydHMgPSAoY29sb3JQaWNrZXIpIC0+XG4gICAgICAgIEVtaXR0ZXI6IChyZXF1aXJlICcuLi9tb2R1bGVzL0VtaXR0ZXInKSgpXG5cbiAgICAgICAgZWxlbWVudDogbnVsbFxuICAgICAgICBjb250cm9sOiBudWxsXG4gICAgICAgIGNhbnZhczogbnVsbFxuXG4gICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgIyAgU2V0IHVwIGV2ZW50cyBhbmQgaGFuZGxpbmdcbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgIyBTZWxlY3Rpb24gQ2hhbmdlZCBldmVudFxuICAgICAgICBlbWl0U2VsZWN0aW9uQ2hhbmdlZDogLT5cbiAgICAgICAgICAgIEBFbWl0dGVyLmVtaXQgJ3NlbGVjdGlvbkNoYW5nZWQnLCBAY29udHJvbC5zZWxlY3Rpb25cbiAgICAgICAgb25TZWxlY3Rpb25DaGFuZ2VkOiAoY2FsbGJhY2spIC0+XG4gICAgICAgICAgICBARW1pdHRlci5vbiAnc2VsZWN0aW9uQ2hhbmdlZCcsIGNhbGxiYWNrXG5cbiAgICAgICAgIyBDb2xvciBDaGFuZ2VkIGV2ZW50XG4gICAgICAgIGVtaXRDb2xvckNoYW5nZWQ6IC0+XG4gICAgICAgICAgICBARW1pdHRlci5lbWl0ICdjb2xvckNoYW5nZWQnLCBAY29udHJvbC5zZWxlY3Rpb24uY29sb3JcbiAgICAgICAgb25Db2xvckNoYW5nZWQ6IChjYWxsYmFjaykgLT5cbiAgICAgICAgICAgIEBFbWl0dGVyLm9uICdjb2xvckNoYW5nZWQnLCBjYWxsYmFja1xuXG4gICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgIyAgQ3JlYXRlIGFuZCBhY3RpdmF0ZSBTYXR1cmF0aW9uIGNvbnRyb2xsZXJcbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgYWN0aXZhdGU6IC0+XG4gICAgICAgICAgICBCb2R5ID0gY29sb3JQaWNrZXIuZ2V0RXh0ZW5zaW9uICdCb2R5J1xuXG4gICAgICAgICMgIENyZWF0ZSBlbGVtZW50XG4gICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgICBAZWxlbWVudCA9XG4gICAgICAgICAgICAgICAgZWw6IGRvIC0+XG4gICAgICAgICAgICAgICAgICAgIF9jbGFzc1ByZWZpeCA9IEJvZHkuZWxlbWVudC5lbC5jbGFzc05hbWVcbiAgICAgICAgICAgICAgICAgICAgX2VsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCAnZGl2J1xuICAgICAgICAgICAgICAgICAgICBfZWwuY2xhc3NMaXN0LmFkZCBcIiN7IF9jbGFzc1ByZWZpeCB9LXNhdHVyYXRpb25cIlxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBfZWxcbiAgICAgICAgICAgICAgICAjIFV0aWxpdHkgZnVuY3Rpb25zXG4gICAgICAgICAgICAgICAgd2lkdGg6IDBcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IDBcbiAgICAgICAgICAgICAgICBnZXRXaWR0aDogLT4gcmV0dXJuIEB3aWR0aCBvciBAZWwub2Zmc2V0V2lkdGhcbiAgICAgICAgICAgICAgICBnZXRIZWlnaHQ6IC0+IHJldHVybiBAaGVpZ2h0IG9yIEBlbC5vZmZzZXRIZWlnaHRcblxuICAgICAgICAgICAgICAgIHJlY3Q6IG51bGxcbiAgICAgICAgICAgICAgICBnZXRSZWN0OiAtPiByZXR1cm4gQHJlY3Qgb3IgQHVwZGF0ZVJlY3QoKVxuICAgICAgICAgICAgICAgIHVwZGF0ZVJlY3Q6IC0+IEByZWN0ID0gQGVsLmdldENsaWVudFJlY3RzKClbMF1cblxuICAgICAgICAgICAgICAgICMgQWRkIGEgY2hpbGQgb24gdGhlIFNhdHVyYXRpb24gZWxlbWVudFxuICAgICAgICAgICAgICAgIGFkZDogKGVsZW1lbnQpIC0+XG4gICAgICAgICAgICAgICAgICAgIEBlbC5hcHBlbmRDaGlsZCBlbGVtZW50XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzXG4gICAgICAgICAgICBCb2R5LmVsZW1lbnQuYWRkIEBlbGVtZW50LmVsLCAwXG5cbiAgICAgICAgIyAgVXBkYXRlIGVsZW1lbnQgcmVjdCB3aGVuIENvbG9yIFBpY2tlciBvcGVuc1xuICAgICAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICAgICAgY29sb3JQaWNrZXIub25PcGVuID0+XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVubGVzcyBAZWxlbWVudC51cGRhdGVSZWN0KCkgYW5kIF9yZWN0ID0gQGVsZW1lbnQuZ2V0UmVjdCgpXG4gICAgICAgICAgICAgICAgQHdpZHRoID0gX3JlY3Qud2lkdGhcbiAgICAgICAgICAgICAgICBAaGVpZ2h0ID0gX3JlY3QuaGVpZ2h0XG5cbiAgICAgICAgIyAgQ3JlYXRlIGFuZCBkcmF3IGNhbnZhc1xuICAgICAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICAgICAgc2V0VGltZW91dCA9PiAjIHdhaXQgZm9yIHRoZSBET01cbiAgICAgICAgICAgICAgICBTYXR1cmF0aW9uID0gdGhpc1xuICAgICAgICAgICAgICAgIEh1ZSA9IGNvbG9yUGlja2VyLmdldEV4dGVuc2lvbiAnSHVlJ1xuXG4gICAgICAgICAgICAgICAgIyBQcmVwYXJlIHNvbWUgdmFyaWFibGVzXG4gICAgICAgICAgICAgICAgX2VsZW1lbnRXaWR0aCA9IEBlbGVtZW50LmdldFdpZHRoKClcbiAgICAgICAgICAgICAgICBfZWxlbWVudEhlaWdodCA9IEBlbGVtZW50LmdldEhlaWdodCgpXG5cbiAgICAgICAgICAgICAgICAjIENyZWF0ZSBlbGVtZW50XG4gICAgICAgICAgICAgICAgQGNhbnZhcyA9XG4gICAgICAgICAgICAgICAgICAgIGVsOiBkbyAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgX2VsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCAnY2FudmFzJ1xuICAgICAgICAgICAgICAgICAgICAgICAgX2VsLndpZHRoID0gX2VsZW1lbnRXaWR0aFxuICAgICAgICAgICAgICAgICAgICAgICAgX2VsLmhlaWdodCA9IF9lbGVtZW50SGVpZ2h0XG4gICAgICAgICAgICAgICAgICAgICAgICBfZWwuY2xhc3NMaXN0LmFkZCBcIiN7IFNhdHVyYXRpb24uZWxlbWVudC5lbC5jbGFzc05hbWUgfS1jYW52YXNcIlxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2VsXG4gICAgICAgICAgICAgICAgICAgICMgVXRpbGl0eSBmdW5jdGlvbnNcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dDogbnVsbFxuICAgICAgICAgICAgICAgICAgICBnZXRDb250ZXh0OiAtPiBAY29udGV4dCBvciAoQGNvbnRleHQgPSBAZWwuZ2V0Q29udGV4dCAnMmQnKVxuXG4gICAgICAgICAgICAgICAgICAgIGdldENvbG9yQXRQb3NpdGlvbjogKHgsIHkpIC0+IHJldHVybiBjb2xvclBpY2tlci5TbWFydENvbG9yLkhTVkFycmF5IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIEh1ZS5nZXRIdWUoKVxuICAgICAgICAgICAgICAgICAgICAgICAgeCAvIFNhdHVyYXRpb24uZWxlbWVudC5nZXRXaWR0aCgpICogMTAwXG4gICAgICAgICAgICAgICAgICAgICAgICAxMDAgLSAoeSAvIFNhdHVyYXRpb24uZWxlbWVudC5nZXRIZWlnaHQoKSAqIDEwMCldXG5cbiAgICAgICAgICAgICAgICAgICAgIyBSZW5kZXIgU2F0dXJhdGlvbiBjYW52YXNcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNSZW5kZXI6IG51bGxcbiAgICAgICAgICAgICAgICAgICAgcmVuZGVyOiAoc21hcnRDb2xvcikgLT5cbiAgICAgICAgICAgICAgICAgICAgICAgIF9oc2xBcnJheSA9ICggZG8gLT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmxlc3Mgc21hcnRDb2xvclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29sb3JQaWNrZXIuU21hcnRDb2xvci5IRVggJyNmMDAnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gc21hcnRDb2xvclxuICAgICAgICAgICAgICAgICAgICAgICAgKS50b0hTTEFycmF5KClcblxuICAgICAgICAgICAgICAgICAgICAgICAgX2pvaW5lZCA9IF9oc2xBcnJheS5qb2luICcsJ1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlmIEBwcmV2aW91c1JlbmRlciBhbmQgQHByZXZpb3VzUmVuZGVyIGlzIF9qb2luZWRcblxuICAgICAgICAgICAgICAgICAgICAgICAgIyBHZXQgY29udGV4dCBhbmQgY2xlYXIgaXRcbiAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0ID0gQGdldENvbnRleHQoKVxuICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQuY2xlYXJSZWN0IDAsIDAsIF9lbGVtZW50V2lkdGgsIF9lbGVtZW50SGVpZ2h0XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICMgRHJhdyBodWUgY2hhbm5lbCBvbiB0b3BcbiAgICAgICAgICAgICAgICAgICAgICAgIF9ncmFkaWVudCA9IF9jb250ZXh0LmNyZWF0ZUxpbmVhckdyYWRpZW50IDAsIDAsIF9lbGVtZW50V2lkdGgsIDFcbiAgICAgICAgICAgICAgICAgICAgICAgIF9ncmFkaWVudC5hZGRDb2xvclN0b3AgLjAxLCAnaHNsKDAsMTAwJSwxMDAlKSdcbiAgICAgICAgICAgICAgICAgICAgICAgIF9ncmFkaWVudC5hZGRDb2xvclN0b3AgLjk5LCBcImhzbCgjeyBfaHNsQXJyYXlbMF0gfSwxMDAlLDUwJSlcIlxuXG4gICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dC5maWxsU3R5bGUgPSBfZ3JhZGllbnRcbiAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0LmZpbGxSZWN0IDAsIDAsIF9lbGVtZW50V2lkdGgsIF9lbGVtZW50SGVpZ2h0XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICMgRHJhdyBzYXR1cmF0aW9uIGNoYW5uZWwgb24gdGhlIGJvdHRvbVxuICAgICAgICAgICAgICAgICAgICAgICAgX2dyYWRpZW50ID0gX2NvbnRleHQuY3JlYXRlTGluZWFyR3JhZGllbnQgMCwgMCwgMSwgX2VsZW1lbnRIZWlnaHRcbiAgICAgICAgICAgICAgICAgICAgICAgIF9ncmFkaWVudC5hZGRDb2xvclN0b3AgLjAxLCAncmdiYSgwLDAsMCwwKSdcbiAgICAgICAgICAgICAgICAgICAgICAgIF9ncmFkaWVudC5hZGRDb2xvclN0b3AgLjk5LCAncmdiYSgwLDAsMCwxKSdcblxuICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQuZmlsbFN0eWxlID0gX2dyYWRpZW50XG4gICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dC5maWxsUmVjdCAwLCAwLCBfZWxlbWVudFdpZHRoLCBfZWxlbWVudEhlaWdodFxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEBwcmV2aW91c1JlbmRlciA9IF9qb2luZWRcblxuICAgICAgICAgICAgICAgICMgUmVuZGVyIGFnYWluIG9uIEh1ZSBzZWxlY3Rpb24gY2hhbmdlXG4gICAgICAgICAgICAgICAgSHVlLm9uQ29sb3JDaGFuZ2VkIChzbWFydENvbG9yKSA9PlxuICAgICAgICAgICAgICAgICAgICBAY2FudmFzLnJlbmRlciBzbWFydENvbG9yXG4gICAgICAgICAgICAgICAgQGNhbnZhcy5yZW5kZXIoKVxuXG4gICAgICAgICAgICAgICAgIyBBZGQgdG8gU2F0dXJhdGlvbiBlbGVtZW50XG4gICAgICAgICAgICAgICAgQGVsZW1lbnQuYWRkIEBjYW52YXMuZWxcblxuICAgICAgICAjICBDcmVhdGUgU2F0dXJhdGlvbiBjb250cm9sIGVsZW1lbnRcbiAgICAgICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgICAgIHNldFRpbWVvdXQgPT4gIyB3YWl0IGZvciB0aGUgRE9NXG4gICAgICAgICAgICAgICAgaGFzQ2hpbGQgPSAoZWxlbWVudCwgY2hpbGQpIC0+XG4gICAgICAgICAgICAgICAgICAgIGlmIGNoaWxkIGFuZCBfcGFyZW50ID0gY2hpbGQucGFyZW50Tm9kZVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgY2hpbGQgaXMgZWxlbWVudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBoYXNDaGlsZCBlbGVtZW50LCBfcGFyZW50XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZVxuXG4gICAgICAgICAgICAgICAgIyBDcmVhdGUgZWxlbWVudFxuICAgICAgICAgICAgICAgIFNhdHVyYXRpb24gPSB0aGlzXG4gICAgICAgICAgICAgICAgSHVlID0gY29sb3JQaWNrZXIuZ2V0RXh0ZW5zaW9uICdIdWUnXG5cbiAgICAgICAgICAgICAgICBAY29udHJvbCA9XG4gICAgICAgICAgICAgICAgICAgIGVsOiBkbyAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgX2VsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCAnZGl2J1xuICAgICAgICAgICAgICAgICAgICAgICAgX2VsLmNsYXNzTGlzdC5hZGQgXCIjeyBTYXR1cmF0aW9uLmVsZW1lbnQuZWwuY2xhc3NOYW1lIH0tY29udHJvbFwiXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZWxcbiAgICAgICAgICAgICAgICAgICAgaXNHcmFiYmluZzogbm9cblxuICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0NvbnRyb2xQb3NpdGlvbjogbnVsbFxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVDb250cm9sUG9zaXRpb246ICh4LCB5KSAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgX2pvaW5lZCA9IFwiI3sgeCB9LCN7IHkgfVwiXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWYgQHByZXZpb3VzQ29udHJvbFBvc2l0aW9uIGFuZCBAcHJldmlvdXNDb250cm9sUG9zaXRpb24gaXMgX2pvaW5lZFxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBAZWwuc3R5bGUubGVmdCA9IFwiI3sgeCB9cHhcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIEBlbC5zdHlsZS50b3AgPSBcIiN7IHkgfXB4XCJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBAcHJldmlvdXNDb250cm9sUG9zaXRpb24gPSBfam9pbmVkXG5cbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uOlxuICAgICAgICAgICAgICAgICAgICAgICAgeDogbnVsbFxuICAgICAgICAgICAgICAgICAgICAgICAgeTogMFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG51bGxcbiAgICAgICAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uOiAoZSwgc2F0dXJhdGlvbj1udWxsLCBrZXk9bnVsbCkgLT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmxlc3MgU2F0dXJhdGlvbi5jYW52YXMgYW5kIF9yZWN0ID0gU2F0dXJhdGlvbi5lbGVtZW50LmdldFJlY3QoKVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBfd2lkdGggPSBTYXR1cmF0aW9uLmVsZW1lbnQuZ2V0V2lkdGgoKVxuICAgICAgICAgICAgICAgICAgICAgICAgX2hlaWdodCA9IFNhdHVyYXRpb24uZWxlbWVudC5nZXRIZWlnaHQoKVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiBlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3ggPSBlLnBhZ2VYIC0gX3JlY3QubGVmdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF95ID0gZS5wYWdlWSAtIF9yZWN0LnRvcFxuICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXQgc2F0dXJhdGlvbiBhbmQga2V5IGRpcmVjdGx5XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2Ygc2F0dXJhdGlvbiBpcyAnbnVtYmVyJykgYW5kICh0eXBlb2Yga2V5IGlzICdudW1iZXInKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF94ID0gX3dpZHRoICogc2F0dXJhdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF95ID0gX2hlaWdodCAqIGtleVxuICAgICAgICAgICAgICAgICAgICAgICAgIyBEZWZhdWx0IHRvIHByZXZpb3VzIHZhbHVlc1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgQHNlbGVjdGlvbi54IGlzbnQgJ251bWJlcicpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEBzZWxlY3Rpb24ueCA9IF93aWR0aFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF94ID0gQHNlbGVjdGlvbi54XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3kgPSBAc2VsZWN0aW9uLnlcblxuICAgICAgICAgICAgICAgICAgICAgICAgX3ggPSBAc2VsZWN0aW9uLnggPSBNYXRoLm1heCAwLCAoTWF0aC5taW4gX3dpZHRoLCBNYXRoLnJvdW5kIF94KVxuICAgICAgICAgICAgICAgICAgICAgICAgX3kgPSBAc2VsZWN0aW9uLnkgPSBNYXRoLm1heCAwLCAoTWF0aC5taW4gX2hlaWdodCwgTWF0aC5yb3VuZCBfeSlcblxuICAgICAgICAgICAgICAgICAgICAgICAgX3Bvc2l0aW9uID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4OiBNYXRoLm1heCA2LCAoTWF0aC5taW4gKF93aWR0aCAtIDcpLCBfeClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5OiBNYXRoLm1heCA2LCAoTWF0aC5taW4gKF9oZWlnaHQgLSA3KSwgX3kpXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIEBzZWxlY3Rpb24uY29sb3IgPSBTYXR1cmF0aW9uLmNhbnZhcy5nZXRDb2xvckF0UG9zaXRpb24gX3gsIF95XG4gICAgICAgICAgICAgICAgICAgICAgICBAdXBkYXRlQ29udHJvbFBvc2l0aW9uIF9wb3NpdGlvbi54LCBfcG9zaXRpb24ueVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFNhdHVyYXRpb24uZW1pdFNlbGVjdGlvbkNoYW5nZWQoKVxuXG4gICAgICAgICAgICAgICAgICAgIHJlZnJlc2hTZWxlY3Rpb246IC0+IEBzZXRTZWxlY3Rpb24oKVxuICAgICAgICAgICAgICAgIEBjb250cm9sLnJlZnJlc2hTZWxlY3Rpb24oKVxuXG4gICAgICAgICAgICAgICAgIyBJZiB0aGUgQ29sb3IgUGlja2VyIGlzIGZlZCBhIGNvbG9yLCBzZXQgaXRcbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5vbklucHV0Q29sb3IgKHNtYXJ0Q29sb3IpID0+XG4gICAgICAgICAgICAgICAgICAgIFtoLCBzLCB2XSA9IHNtYXJ0Q29sb3IudG9IU1ZBcnJheSgpXG4gICAgICAgICAgICAgICAgICAgIEBjb250cm9sLnNldFNlbGVjdGlvbiBudWxsLCBzLCAoMSAtIHYpXG5cbiAgICAgICAgICAgICAgICAjIFdoZW4gdGhlIHNlbGVjdGlvbiBjaGFuZ2VzLCB0aGUgY29sb3IgaGFzIGNoYW5nZWRcbiAgICAgICAgICAgICAgICBTYXR1cmF0aW9uLm9uU2VsZWN0aW9uQ2hhbmdlZCAtPiBTYXR1cmF0aW9uLmVtaXRDb2xvckNoYW5nZWQoKVxuXG4gICAgICAgICAgICAgICAgIyBSZXNldFxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLm9uT3BlbiA9PiBAY29udHJvbC5yZWZyZXNoU2VsZWN0aW9uKClcbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5vbk9wZW4gPT4gQGNvbnRyb2wuaXNHcmFiYmluZyA9IG5vXG4gICAgICAgICAgICAgICAgY29sb3JQaWNrZXIub25DbG9zZSA9PiBAY29udHJvbC5pc0dyYWJiaW5nID0gbm9cblxuICAgICAgICAgICAgICAgICMgQmluZCBjb250cm9sbGVyIGV2ZW50c1xuICAgICAgICAgICAgICAgIEh1ZS5vbkNvbG9yQ2hhbmdlZCA9PiBAY29udHJvbC5yZWZyZXNoU2VsZWN0aW9uKClcblxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLm9uTW91c2VEb3duIChlLCBpc09uUGlja2VyKSA9PlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5sZXNzIGlzT25QaWNrZXIgYW5kIGhhc0NoaWxkIFNhdHVyYXRpb24uZWxlbWVudC5lbCwgZS50YXJnZXRcbiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpXG4gICAgICAgICAgICAgICAgICAgIEBjb250cm9sLmlzR3JhYmJpbmcgPSB5ZXNcbiAgICAgICAgICAgICAgICAgICAgQGNvbnRyb2wuc2V0U2VsZWN0aW9uIGVcblxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLm9uTW91c2VNb3ZlIChlKSA9PlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5sZXNzIEBjb250cm9sLmlzR3JhYmJpbmdcbiAgICAgICAgICAgICAgICAgICAgQGNvbnRyb2wuc2V0U2VsZWN0aW9uIGVcblxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLm9uTW91c2VVcCAoZSkgPT5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVubGVzcyBAY29udHJvbC5pc0dyYWJiaW5nXG4gICAgICAgICAgICAgICAgICAgIEBjb250cm9sLmlzR3JhYmJpbmcgPSBub1xuICAgICAgICAgICAgICAgICAgICBAY29udHJvbC5zZXRTZWxlY3Rpb24gZVxuXG4gICAgICAgICAgICAgICAgIyBBZGQgdG8gU2F0dXJhdGlvbiBlbGVtZW50XG4gICAgICAgICAgICAgICAgQGVsZW1lbnQuYWRkIEBjb250cm9sLmVsXG4gICAgICAgICAgICByZXR1cm4gdGhpc1xuIl19
